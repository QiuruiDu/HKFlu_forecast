################################################################################
# read data
################################################################################
# 进行结果的计???
library(plyr)
library(dplyr)
library(tidyverse)
library(ISOweek)
library(locpol)
library(forecast)
library(scoringutils)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(cowplot)
library(data.table)
source('MyPlot.R')
###########################################
# preparation
###########################################
origin_path = '/Users/hkuph/richael/flu/SBEM_for_HKILI'
setwd(origin_path)
models = c('baseline',
# 'arima_weekid_monthid','arima_add_cov',
# 'garch_weekid_monthid','garch_add_cov',
'lstm_v1_non_rolling',	'lstm_v3_non_rolling',
'gru_v1_non_rolling',	'gru_v3_non_rolling'
# 'rf_specified_lag','rf_auto_lag',
# 'xgb_specified_lag','xgb_auto_lag'
)
mode = 'validation'
# Load projections from components models -----------------------
proj<-tibble()
for (model in models){
path_ = paste0(origin_path, '/Results/Quantiles/quantile_',model,'_',mode,'.csv')
proj_tmp<-read.csv(file=path_,stringsAsFactors =F)
proj_tmp$model = model
proj_tmp$date = as.Date(proj_tmp$date)
proj<-rbind.fill(proj,proj_tmp)
}
proj$model<-factor(proj$model,levels=models, ordered=T)
################################################################################
# compute for train or test mode - no season
################################################################################
proj.mode <- proj %>%
mutate(date=as.Date(date)) %>%
mutate(date_origin=date-week_ahead*7) %>%
# mutate(weekid = as.numeric(strftime(date,format= "%V"))) %>%
mutate(weekid_pred = as.numeric(strftime(date,format= "%V")))
proj.mode <- proj %>%
mutate(date=as.Date(date)) %>%
mutate(date_origin=date-week_ahead*7) %>%
# mutate(weekid = as.numeric(strftime(date,format= "%V"))) %>%
mutate(weekid_pred = as.numeric(strftime(date,format= "%V")))
# exclusion of lockdown
proj.mode$inclusion<-1
res.origin<-proj.mode %>%
mutate(in_interval95 = true >= lower_5 & true <= upper_5) %>%
mutate(abs_error = abs(point - true)) %>%
mutate(bias = abs((point - true) / true))
res.origin<-my.plot(proj.mode)
res.origin<-my.compute(proj.mode)
# number of removed data points (not consolidated) # for HK 1 day delay is OK
remove_last_n <- 1
View(proj.mode)
View(res.origin)
proj.mode <- proj %>%
mutate(date=as.Date(date)) %>%
# mutate(date_origin=date-week_ahead*7) %>%
# mutate(weekid = as.numeric(strftime(date,format= "%V"))) %>%
mutate(weekid_pred = as.numeric(strftime(date,format= "%V")))
# exclusion of lockdown
proj.mode$inclusion<-1
res.origin<-my.compute(proj.mode)
res<-my.compute(proj.mode)
evual_result<-res %>%
filter(inclusion==1) %>%
filter(var=="iHosp") %>%
mutate(week_ahead=as.factor(week_ahead)) %>%
group_by(model,var,week_ahead) %>%
dplyr::summarize(rmse = sqrt(mean(abs_error^2,na.rm=T)) ,avg_wis = (mean(wis,na.rm=T)),
mape = (mean(bias,na.rm=T)))%>%
ungroup()
index_list = c('avg_wis','rmse')
re_evual_result = dcast(data.table(evual_result), model + var~week_ahead, value.var = 'mape')
start_ = 4-1
end_ = 8-1
names(re_evual_result)[start_:end_] <- paste0('mape',0:4)
for(c in index_list){
re_c = dcast(data.table(evual_result), model + var~week_ahead, value.var = c)
names(re_c)[start_:end_] <- paste0(c,0:4)
re_evual_result = cbind(re_evual_result,re_c[,start_:end_])
}
View(re_evual_result)
result_save_path = paste0(origin_path,'/Results/all_evaluate_index_',mode,'.csv') #_split_season
write.csv(re_evual_result, file = result_save_path, row.names = FALSE)
################################################################################
# compute for train - split season
################################################################################
proj.mode <- proj %>%
mutate(date=as.Date(date)) %>%
mutate(date_origin=date-week_ahead*7) %>%
# mutate(weekid = as.numeric(strftime(date,format= "%V"))) %>%
mutate(weekid_pred = as.numeric(strftime(date,format= "%V")))
# exclusion of lockdown
proj.mode$inclusion<-1
# 生成季节信号
proj.mode <- proj.mode %>%
mutate(monthid = as.numeric(strftime(date, format = "%m")))%>%
mutate(seasonid = 0)
proj.mode$seasonid[which(proj.mode$monthid %in% c(12,1,2,3,4,5))] <- 1
proj.mode <- proj.mode %>%
dplyr::select(-monthid)
# # 计算指标 -----------------------
res -> my.compute(proj.mode)
View(my.compute)
# # 计算指标 -----------------------
res -> my.compute(proj.mode)
# # 计算指标 -----------------------
setwd('/Users/hkuph/richael/flu/SBEM_for_HKILI/Scripts/r/tools')
source('MyPlot.R')
res -> my.compute(proj.mode)
